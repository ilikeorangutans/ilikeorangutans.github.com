<!DOCTYPE html>
<html>
  <head>
        <meta charset="utf-8">
    <title>
      
        OMF &mdash;
      
      Jakob Külzer
    </title>

    <meta name="author" value="Jakob Külzer">
    <meta property="og:title" content="OMF">
    <meta property="og:description" content="OMF, short for Object Manager Framework, is a Java project that enables annotation driven mapping of POJOs to Java Content Repository structures. Mapped POJOs allow transparent access to the underlying graph storage with support for primitive types, Lists, and Maps. I built OMF while working on Adobe CQ systems; data access was always too cumbersome and led to very brittle, hard to compose code, so a framework that generates bytecode on the fly to abstract away the repetitive data access tasks seemed the obvious choice.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://ilikeorangutans.github.io/projects/omf/">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate" href="https://ilikeorangutans.github.io/index.xml" type="application/rss+xml" title="Jakob Külzer">

    <link rel="stylesheet" href="/css/spectre.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <link rel="canonical" href="https://ilikeorangutans.github.io/">

  </head>
  <body>
    
    <div class="container grid-lg">
  <header class="navbar hide-sm">
    <section class="navbar-section">
      <a href="/" class="navbar-brand">
        Jakob Külzer
      </a>
    </section>
    <section class="navbar-section">
      
        <a href="/" class="mr-2 ml-2">
          Home
        </a>
      
        <a href="/posts/" class="mr-2 ml-2">
          Blog
        </a>
      
        <a href="/projects/" class="mr-2 ml-2">
          Projects
        </a>
      
        <a href="/about/" class="mr-2 ml-2">
          About
        </a>
      
    </section>
  </header>

  <header class="show-sm columns">
    <div class="column col-12">
      <a href="/" class="navbar-brand">
        Jakob Külzer
      </a>
    </div>
    <div class="column col-12">
      
        <a href="/" class="mr-2 ml-1">
          Home
        </a>
      
        <a href="/posts/" class="mr-2 ml-1">
          Blog
        </a>
      
        <a href="/projects/" class="mr-2 ml-1">
          Projects
        </a>
      
        <a href="/about/" class="mr-2 ml-1">
          About
        </a>
      
    </div>
  </header>
</div>
<div class="divider"></div>
    
    <main class="container grid-lg content">
      
    <div class="columns mb-2">
        <div class="column">
            <p class="text-gray">
                29 May 2018




            </p>
            <div class="divider"></div>
            
            <h1>OMF</h1>
            <p><a href="https://github.com/ilikeorangutans/omf">OMF</a>, short for Object Manager Framework, is a Java project that enables annotation driven mapping of POJOs to Java Content Repository structures. Mapped POJOs allow transparent access to the underlying graph storage with support for primitive types, Lists, and Maps. I built OMF while working on Adobe CQ systems; data access was always too cumbersome and led to very brittle, hard to compose code, so a framework that generates bytecode on the fly to abstract away the repetitive data access tasks seemed the obvious choice.</p>
<h2 id="background">Background</h2>
<p>A few years ago, I was working on Day CQ 4 and later an it&rsquo;s successor, Adobe CQ. Both of these systems have a graph based storage layer in common. And while CQ4&rsquo;s storage layer was proprietary, the later versions were built on the standardized Java Content Repository (JCR). JCR is an interesting storage mechanism; it&rsquo;s flexible and lends itself well to content management systems. However, I always found the way templates or any kind of code was built against these systems brittle and really hard to reuse. This is because the way the JCR is exposed to CQ templates was as the raw storage primitives. This made it really hard to build semantic models and required tons of repeated code.</p>
<p>I&rsquo;ve had good experiences with Hibernate and really liked the approach it offered. Describe your domain model to the storage layer using special annotations (or the raw XML, if you&rsquo;re into that) and let the storage layer figure out how to build and retrieve domain objects for you.</p>
<h2 id="how-omf-works">How OMF Works</h2>
<p>Fundamentally OMF does three things. First, it builds a model of your annotated POJOs that describes how its fields map to JCR nodes and properties. Second, using the model, OMF&rsquo;s session can create proxies for the POJOs that intercept all calls to annotated fields and redirect them. Third, the redirect calls to annotated fields are intercepted by persistence interceptor which uses the mapping, the JCR session and and the annotated field to access the JCR nodes and retrieve the desired data.</p>
<h2 id="what-ive-learnt">What I&rsquo;ve Learnt</h2>
<p>Building OMF was interesting because I needed to create dynamic proxies. The JDK offers a standard Proxy type that lets one create a proxy for a given Java interface type. However, this didn&rsquo;t work well with my goal of annotated POJOs. I needed arbitrary proxies that would let me intercept specific method calls. The solution was to dynamically generate new bytecode at runtime using <a href="https://github.com/cglib/cglib">cglib</a>. It&rsquo;s really fascinating that one can generate new executable code and then have the VM load it at runtime.</p>
<p>But I really had to dig deep into Java class loading and OSGI class loading in particular. You see, in a regular Java app, class loaders form a straightforward hierarchy. In OSGI on the other hand, class loading is heavily regulated, and bytecode generated at runtime was a bit of a challenge to get right. In the end I got it working.</p>
<p>Most importantly though, I wrote the core of the OMF framework using Object Oriented Calisthenics, an approach that thought me much about object oriented code can be nice and composable. It was also the first project where I wrote everything with test coverage &ndash; at a time when I hadn&rsquo;t fully understood TDD and tests were generally considered a waste of time by my employers, it was kind of eye-opening that unit tests could be so useful and easy to write.</p>

            <div class="divider"></div>
        </div>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ilikeorangutans" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </main>
    
    <div class="divider"></div>
<div class="container grid-lg mb-2">
    <footer class="navbar text-gray">
        <section class="navbar-section">
            &copy; 2018 Jakob Külzer
        </section>
        <section class="navbar-center">
            <a href="mailto:jakob.kuelzer@gmail.com" class="btn btn-link">Email</a> |
            <a href="https://github.com/ilikeorangutans" target="_blank" class="btn btn-link">Github</a> |
            <a href="https://www.linkedin.com/in/jakobkuelzer/" target="_blank" class="btn btn-link">LinkedIn</a> |
            <a href="/index.xml" class="btn btn-link">RSS</a>
        </section>
        <section class="navbar-section"></section>
    </footer>
</div>

    
  </body>
</html>