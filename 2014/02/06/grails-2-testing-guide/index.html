<!doctype html><html><head><meta charset=utf-8><title>Grails 2 Testing Guide &mdash;
Jakob Külzer</title><meta name=author value="Jakob Külzer"><meta property="og:title" content="Grails 2 Testing Guide"><meta property="og:description" content="Note: I&rsquo;m still working on this post, but I already use it as a reference so there&rsquo;ll be more content over time.
I&rsquo;ve been quite busy at work with updating a Grails 1.3 application to 2.3.4. While writing a test harness it became apparent that lots of things have changed since I&rsquo;ve last worked with Grails. Many changes are for the better, especially the integration of Spock framework. However, there were some issues that took me a while to figure out. The Grails docs on testing are comprehensive, but long. Here&rsquo;s my cheat sheet."><meta property="og:type" content="article"><meta property="og:url" content="https://ilikeorangutans.github.io/2014/02/06/grails-2-testing-guide/"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/output.css><link rel=canonical href=https://ilikeorangutans.github.io/></head><body class="bg-gray-50 text-gray-900"><header class="bg-white shadow-sm border-b"><div class="max-w-4xl mx-auto px-4 py-6"><nav class="flex justify-between items-center"><a href=/ class=navbar-brand><h1 class="text-2xl font-bold text-teal-900 hover:text-orange-400 transition-colors">Jakob Külzer</h1></a><div class=space-x-6><a href=/ class="text-gray-600 hover:text-orange-400 transition-colors">Home</a>
<a href=/posts/ class="text-gray-600 hover:text-orange-400 transition-colors">Blog</a>
<a href=/projects/ class="text-gray-600 hover:text-orange-400 transition-colors">Projects</a>
<a href=/about/ class="text-gray-600 hover:text-orange-400 transition-colors">About</a></div></nav></div></header><main class="max-w-4xl mx-auto px-4 py-8"><article class="bg-white rounded-lg shadow-sm overflow-hidden"><div class=p-6><div class="text-sm text-gray-500"><time datetime=2014-02-06>6 Feb 2014
</time><time datetime=2018-03-28>• updated 28 Mar 2018</time></div><h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">Grails 2 Testing Guide</h1><div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-200"><div class="flex flex-wrap gap-2 mb-4"><a href=/tags/grails class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Grails
</a><a href=/tags/grails-2.3.x class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Grails-2.3.x
</a><a href=/tags/unit-testing class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Unit Testing
</a><a href=/tags/spock class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Spock
</a><a href=/tags/groovy class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Groovy
</a><a href=/tags/test-driven-development class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Test Driven Development
</a><a href=/tags/integration-testing class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Integration Testing</a></div></div><div class="prose prose-lg max-w-none"><p><strong>Note: I&rsquo;m still working on this post, but I already use it as a reference so there&rsquo;ll be more content over time.</strong></p><p>I&rsquo;ve been quite busy at work with updating a Grails 1.3 application to 2.3.4. While writing a test harness it became apparent that lots of things have changed since I&rsquo;ve last worked with Grails. Many changes are for the better, especially the integration of Spock framework. However, there were some issues that took me a while to figure out. The Grails docs on <a href=http://grails.org/doc/latest/guide/testing.html>testing</a> are comprehensive, but long. Here&rsquo;s my cheat sheet.</p><h2 id=general>General</h2><h3 id=tests--assertions>Tests & Assertions</h3><p>Tests without assertions are mostly pointless. Learn to write effective assertions. <a href=https://code.google.com/p/hamcrest/wiki/Tutorial>Hamcrest matchers</a> are there to help you. If you&rsquo;re writing <a href=http://spockframework.org>Spock</a> tests, you don&rsquo;t even need to write any explicit asserts.</p><h3 id=use-appropriate-test-type>Use Appropriate Test Type</h3><p><em>Unit tests</em> are small, self contained, and quick. Whenever you want to test a single method or class, a unit test is usually the way to go. If you find yourself writing a unit test that relies on something else, you&rsquo;ll either want to make it an integration test or mock the collaborators. Using mocks you can precisely control what conditions your code runs under. You can control return values, exceptions, number of interactions, etc.
In Grails, unit tests go under <code>test/unit</code>.</p><p><em>Integration tests</em> are more sophisticated. They actually spin up the runtime environment with all its services, dependency injection, etc to provide a full system. Therefore they are slower than unit tests, but give you a better understanding how your components interact. I like to think of integration tests as tests that take an entire slice of the system and test the interactions between the involved classes. Integration tests go under <code>test/integration</code>.</p><h3 id=disabling-tests>Disabling Tests</h3><p>Whenever you need to disable a test, use the approriate annotation. Commenting out a test is not an acceptable solution. In GroovyUnit or regular JUnit tests, use <code>@org.junit.Ignore</code> and in Spock tests <code>@spock.lang.Ignore</code>. Notice that both annotations take a String parameter that communicates why this test was disabled. Use it to make it clear why a given test was disabled.</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>	<span style=color:#ff8000;font-weight:700>@Ignore</span><span style=color:#2c5dcd>(</span><span style=color:#0c6>&#34;do not need to test this right now&#34;</span><span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test for a method&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>	<span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h3 id=never-mix-test-constructs>Never Mix Test Constructs</h3><p>Between unit and integration tests there are huge differences. <strong>Never mix constructs meant for unit tests with integration tests</strong>.</p><h3 id=groovyunit-or-spock>GroovyUnit or Spock</h3><p>Personally I find Spock tests much more expressive than GroovyUnit tests. Quick sample:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>FooSpecification</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test for a method&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		setup: <span style=color:#0080ff;font-style:italic>// implicit, no need to declare this:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Everything after this statement will be treated as an assertion
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		expect:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		add<span style=color:#2c5dcd>(</span><span style=color:#5918bb;font-weight:700>2</span> <span style=color:#2c5dcd>+</span> <span style=color:#5918bb;font-weight:700>2</span><span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>==</span> <span style=color:#5918bb;font-weight:700>4</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p>Check out the <a href=http://docs.spockframework.org/en/latest/>Spock docs</a>, <a href=https://code.google.com/p/spock/wiki/Examples>samples</a></p><h2 id=unit-tests>Unit Tests</h2><p>Unit tests are tests where you want to test only a very specific piece of code, a single unit. That means that all dependencies of that code will have to be mocked or stubbed. The test setup is the same for all unit tests and starts by annotating your unit test with the <code>@TestFor</code> annotation. This tells Grails what class you want to test and what variables to create.</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestFor</span><span style=color:#2c5dcd>(</span>MyController<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpec</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test something&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Grails automatically created a controller field for us:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>doSomething</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h3 id=configuration>Configuration</h3><p>Grails&rsquo; config is usually accessed via an injected instance of <code>GrailsApplication</code> using the <code>config</code> property. Grails injects <code>GrailsApplication</code> into unit tests, so you can access it directly:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestMixin</span><span style=color:#2c5dcd>(</span>GrailsUnitTestMixin<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MySpec</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test something with config&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// grailsApplication gets automatically injected
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		grailsApplication<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>config</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>myConfigValue</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h3 id=mocks>Mocks</h3><p>During a unit test Grails will not create and inject any dependencies for you so it&rsquo;s up to you to do so. There&rsquo;s plenty of things your code interacts with and this section breaks down how to mock these things.</p><h4 id=mocking-logging>Mocking Logging</h4><p>Almost all loggers in Grails artifacts are injected automatically at runtime. However In unit tests you&rsquo;ll have to tell the framework explicitly what you want logging for.</p><p>TODO: Mock() - what does it do?</p><h4 id=mocking-domain-classes>Mocking Domain Classes</h4><p>Mocking domain classes is a quick and easy way to provide your test code with input. Mocking domain classes is easy, either you provide a <code>@grails.test.mixin.Mock</code> annotation with the domain classes you need, or you use the
<code>mockDomain()</code> method which is added to your test by the <code>GrailsUnitTestMixin</code>. One nice thing about the mocked domain objects is that they support most Gorm operations, including criteria and dynamic finders.</p><p>If you need to provide your test with data through mocks you can either just create the objects and save them or you can pass i</p><p>Example:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestFor</span><span style=color:#2c5dcd>(</span>MyController<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@Mock</span><span style=color:#2c5dcd>([</span> AddressBook <span style=color:#2c5dcd>])</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpec</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>setup</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Explicitly create a new mocked domain object:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		AddressBook addressbook <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>new</span> AddressBook<span style=color:#2c5dcd>(</span>name: <span style=color:#0c6>&#39;Personal Addressbook&#39;</span><span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>		addressBook<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>save</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Or provide an entry as a list.
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		mockDomain<span style=color:#2c5dcd>(</span>Entry<span style=color:#2c5dcd>,</span> <span style=color:#2c5dcd>[</span>
</span></span><span style=display:flex><span>			<span style=color:#2c5dcd>[</span> firstName: <span style=color:#0c6>&#39;Hans&#39;</span><span style=color:#2c5dcd>,</span> lastName: <span style=color:#0c6>&#39;Dampf&#39;</span><span style=color:#2c5dcd>,</span> addressBook: addressBook <span style=color:#2c5dcd>],</span>
</span></span><span style=display:flex><span>			<span style=color:#2c5dcd>[</span> firstName: <span style=color:#0c6>&#39;Dr&#39;</span><span style=color:#2c5dcd>,</span> lastName: <span style=color:#0c6>&#39;Evil&#39;</span><span style=color:#2c5dcd>,</span> addressBook: addressBook <span style=color:#2c5dcd>]</span>
</span></span><span style=display:flex><span>		<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test something&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// You can now use most Gorm related features, like get:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		AddressBook<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>get</span><span style=color:#2c5dcd>(</span><span style=color:#5918bb;font-weight:700>1</span><span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Dynamic finders:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		Entry<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>findByFirstName</span><span style=color:#2c5dcd>(</span><span style=color:#0c6>&#39;Hans&#39;</span><span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// or Criteria:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		Entry<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>withCriteria</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>			eq<span style=color:#2c5dcd>(</span><span style=color:#0c6>&#39;lastName&#39;</span><span style=color:#2c5dcd>,</span> <span style=color:#0c6>&#39;Evil&#39;</span><span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>		<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p><strong>Note</strong>: if you create test data with mocked domain objects, the constraints on the domain class <em>do</em> apply, even when using <code>mockDomain()</code>! I&rsquo;ve tripped over this a few times. If your mocked domain objects don&rsquo;t show up, make sure
you provide all the necessary fields.</p><h3 id=testing-controllers>Testing Controllers</h3><p>Testing controllers is straightforward, but requires lots of mocking as they rely on many different things: services, command objects, domain objects, etc.</p><h3 id=testing-closures>Testing Closures</h3><p>Methods that accept closures as parameters are a staple in Grails development. For example, the mail plugin uses the following syntax:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>mailService<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>sendMail</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>	from <span style=color:#0c6>&#39;bazinga@test.com&#39;</span>
</span></span><span style=display:flex><span>	to <span style=color:#0c6>&#39;bingo@test.com&#39;</span>
</span></span><span style=display:flex><span>	subject <span style=color:#0c6>&#39;Amazing Stuff&#39;</span>
</span></span><span style=display:flex><span>	text <span style=color:#0c6>&#34;Send me your bank data and we&#39;ll make millions!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p>If you&rsquo;re mocking mailService the question is how to validate the values passed into the closure are correct. The solution is to create a <a href=http://stackoverflow.com/questions/10715919/how-to-mock-domain-specific-closures-in-spock>delegate for the closure</a> that captures the values which then can be verified:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MailVerifier</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>	String to<span style=color:#2c5dcd>,</span> from<span style=color:#2c5dcd>,</span> subject<span style=color:#2c5dcd>,</span> text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>to</span><span style=color:#2c5dcd>(</span>String to<span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>{</span> <span style=color:#2c5dcd;font-weight:700>this</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>to</span> <span style=color:#2c5dcd>=</span> to <span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>from</span><span style=color:#2c5dcd>(</span>String from<span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>{</span> <span style=color:#2c5dcd;font-weight:700>this</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>from</span> <span style=color:#2c5dcd>=</span> from <span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>subject</span><span style=color:#2c5dcd>(</span>String subject<span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>{</span> <span style=color:#2c5dcd;font-weight:700>this</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>subject</span> <span style=color:#2c5dcd>=</span> subject <span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>text</span><span style=color:#2c5dcd>(</span>String text<span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>{</span> <span style=color:#2c5dcd;font-weight:700>this</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>text</span> <span style=color:#2c5dcd>=</span> text <span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p>In your test, you have to set the <code>MailVerifier</code> as the Closure&rsquo;s delegate (example uses Spock):</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>MailVerifier mv <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>new</span> MailVerifier<span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>MailService mailService <span style=color:#2c5dcd>=</span> Mock<span style=color:#2c5dcd>(</span>MailService<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#5918bb;font-weight:700>1</span> <span style=color:#2c5dcd>*</span> mailService<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>sendMail</span><span style=color:#2c5dcd>(!</span><span style=color:#2c5dcd;font-weight:700>null</span><span style=color:#2c5dcd>)</span> <span style=color:#2c5dcd>&gt;&gt;</span> <span style=color:#2c5dcd>{</span> Closure c <span style=color:#2c5dcd>-&gt;</span>
</span></span><span style=display:flex><span>	c<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>delegate</span> <span style=color:#2c5dcd>=</span> mv <span style=color:#0080ff;font-style:italic>// Set delegate
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>	c<span style=color:#2c5dcd>()</span> <span style=color:#0080ff;font-style:italic>// Execute closure
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span><span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>when:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>doSomethingThatSendsMail<span style=color:#2c5dcd>(</span><span style=color:#0c6>&#39;foo@bar.com&#39;</span><span style=color:#2c5dcd>,</span> <span style=color:#0c6>&#39;...&#39;</span><span style=color:#2c5dcd>,</span> <span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>then:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mv<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>to</span> <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#39;foo@bar.com&#39;</span>
</span></span></code></pre></div><h3 id=unit-test-gotchas>Unit Test Gotchas</h3><p>This is a growing list of pain points and their solutions</p><h4 id=converterexception-unconvertable-object-of-class-xxx>ConverterException: Unconvertable Object of class XXX</h4><p>So you&rsquo;re writing a unit test for some service or other class, and after mocking everything out and putting the <code>@TestMixin(GrailsUnitTestMixin)</code> on your test, it blows up with an exception like this:</p><pre><code>Caused by: org.codehaus.groovy.grails.web.converters.exceptions.ConverterException: Unconvertable 	Object of class: com.foobar.domain.MyDomainClass
	at grails.converters.JSON.value(JSON.java:199)
	at grails.converters.JSON.render(JSON.java:133)
	... 41 more
</code></pre><p>The reason for this is that the <code>GrailsUnitTestMixin</code> does not initialize the converter subsystem. To get them working, add the <code>ControllerUnitTestMixin</code> mixin which will set up all the regular converters. See <a href=http://grails.1312388.n4.nabble.com/Error-using-as-JSON-converter-in-a-service-in-a-unit-test-tp4637433p4637457.html>this thread</a>. Example:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestMixin</span><span style=color:#2c5dcd>([</span>GrailsUnitTestMixin<span style=color:#2c5dcd>,</span> ControllerUnitTestMixin<span style=color:#2c5dcd>])</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>ContactUsFormJobSpec</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span></code></pre></div><h4 id=groovylangmissingmethodexception-no-signature-of-method-comfoorainbowaddtocolors>groovy.lang.MissingMethodException: No signature of method: com.foo.Rainbow.addToColors()&mldr;</h4><p>This error happened a few times to me:</p><pre><code>|  groovy.lang.MissingMethodException: No signature of method: com.foo.Rainbow.addToColors() is applicable for argument types: (com.foo.RainbowColor) values: [RainbowColor{id=null, name=Orange}]
Possible solutions: getColors()
	at com.foo.RainbowServiceSpec.test
error(RainbowServiceSpec.groovy:179)
</code></pre><p>This happens when you write a unit test and mock only one of the domain classes, but not the other one. In the above example only <code>Rainbow</code> was mocked. Fix this by mocking all classes:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestFor</span><span style=color:#2c5dcd>(</span>RainbowService<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@Mock</span><span style=color:#2c5dcd>([</span>Rainbow<span style=color:#2c5dcd>,</span> RainbowColor<span style=color:#2c5dcd>])</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>public</span> <span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>RainbowSpec</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{}</span>
</span></span></code></pre></div><h4 id=groovycastexception-cannot-cast-object-comfoorainbow2f7af3-with-class-comfoorainbow-to-class-grailsconvertersjson>GroovyCastException: Cannot cast object &lsquo;com.foo.Rainbow@2f7af3&rsquo; with class &lsquo;com.foo.Rainbow&rsquo; to class &lsquo;grails.converters.JSON&rsquo;</h4><p>This seems to happen because the converters are not properly set up in certain unit tests. So lines like this will fail with the above exception:</p><pre tabindex=0><code>render rainbow as JSON
</code></pre><p>Best fix I&rsquo;ve found takes away some of the readability of the code, but appears to work reliably:</p><pre tabindex=0><code>render new JSON(rainbow)
</code></pre><h4 id=testing-content-negotiation>Testing Content Negotiation</h4><p>Grails allows automatic content negotiation using the <a href=http://grails.org/doc/2.3.4/ref/Controllers/withFormat.html>withFormat</a> block. However, setting the format in unit tests is something I keep tripping over. To set a specific response type use <code>response.format</code>:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@TestFor</span><span style=color:#2c5dcd>(</span>MyController<span style=color:#2c5dcd>)</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpec</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test response&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		response<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>format</span> <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;xml&#39;</span>
</span></span><span style=display:flex><span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>action</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>		expect:
</span></span><span style=display:flex><span>		response<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>contentType</span> <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#39;application/xml&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p>Note that the value to use with <code>response.format</code> is <em>not</em> the mime type, it is the name of what is set in <code>grails-app/conf/Config.groovy</code> in the mime type settings. For example:</p><pre tabindex=0><code>grails.mime.types = [
		all: &#39;*/*&#39;,
		json: [&#39;application/json&#39;, &#39;text/json&#39;],
		xml: [&#39;text/xml&#39;, &#39;application/xml&#39;]
]
</code></pre><p>If you wanted an XML response, you&rsquo;d use <code>response.format = 'xml'</code> and <em>not</em> <code>response.format = 'application/xml'</code>.</p><hr><h2 id=integration-tests>Integration Tests</h2><h3 id=testing-services>Testing Services</h3><p>Services are really straightforward to test. You can even get Grails to automatically inject the service into your test:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyServiceSpecification</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	MyService myService <span style=color:#0080ff;font-style:italic>// Grails will inject the service
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test my service method&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		String result <span style=color:#2c5dcd>=</span> myService<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>doMoreWork</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		expect:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		result <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#39;awesome&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><p>Grails will inject everything that is known to it into your integration test, including services or Grail&rsquo;s application context.</p><h3 id=integration-testing-services>Integration Testing Services</h3><p>Writing integration tests for services is very straightforward. You can get the instance injected directly into your test:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpecification</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	MyService myService <span style=color:#0080ff;font-style:italic>// Injected by grails
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test method on service ...&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		service<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>myMethod</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h3 id=integration-testing-controllers>Integration Testing Controllers</h3><p>Integration testing controllers is just one step away from a full functional test, but has the advantage you don&rsquo;t need to deal with the HTTP details. Unlike a real functional test you don&rsquo;t require actual HTTP clients but you talk to the controller directly. Running the test in the same VM as the application under test also has the added benefit that you can look directly into the application to verify the correct behaviour, e.g. check if necessarey database tables have been created.</p><h4 id=dependencies>Dependencies</h4><p>Unlike services, controllers cannot be injected into integration tests so you&rsquo;ll have to create them. If your controller relies on a service, you&rsquo;ll have to manually inject it. You can get the service by getting it injected into your test:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpecification</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	MyService myService <span style=color:#0080ff;font-style:italic>// We&#39;ll need this service for the controller
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>
</span></span><span style=display:flex><span>	MyController controller
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>setup</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// We have to create our own controller instance:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>new</span> MyController<span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Manual dependency injection:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>myService</span> <span style=color:#2c5dcd>=</span> myService
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h4 id=request-and-response>Request and Response</h4><p>During integration tests Grails will automatically set mocked <a href=http://grails.org/doc/latest/api/org/codehaus/groovy/grails/plugins/testing/GrailsMockHttpServletRequest.html>request</a> and <a href=http://grails.org/doc/latest/api/org/codehaus/groovy/grails/plugins/testing/GrailsMockHttpServletResponse.html>response</a> objects on your controllers. To set request parameters, assign values to <code>controller.params.myParam</code>.</p><p>If your controllers use content type negotiation, you&rsquo;ll have to set the expected content type on the <code>controller.response.format</code> field. Setting <code>controller.params.format</code> will <em>not</em> work and caused me all kinds of unexpected behaviour.</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyControllerSpecification</span> <span style=color:#2c5dcd;font-weight:700>extends</span> Specification <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#ff8000;font-weight:700>setup</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span> <span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#5918bb;font-weight:700>void</span> <span style=color:#0c6>&#34;test my controller action&#34;</span><span style=color:#2c5dcd>()</span> <span style=color:#2c5dcd>{</span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Set request parameters:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>params</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>productId</span> <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;42&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Set a content type:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>response</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>format</span> <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#0080ff;font-style:italic>// Call the controller action under test:
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>myAction</span><span style=color:#2c5dcd>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		expect:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>response</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>status</span> <span style=color:#2c5dcd>==</span> <span style=color:#5918bb;font-weight:700>200</span>
</span></span><span style=display:flex><span>		controller<span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>response</span><span style=color:#2c5dcd>.</span><span style=color:#2c5dcd;font-style:italic>contentAsString</span> <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#39;{&#34;productId&#34;:42,&#34;name&#34;:&#34;cake&#34;}&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#2c5dcd>}</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd>}</span>
</span></span></code></pre></div><h2 id=other-references>Other References</h2><h3 id=grails-13>Grails 1.3</h3><p>Use this fantastic <a href=http://zanthrash.com/grailstesting/UnitTestingCheatSheet.pdf>testing cheatsheet for Grails 1.3.x.</a>.</p></div></div></article><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ilikeorangutans.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer class="bg-white border-t mt-12"><div class="max-w-4xl mx-auto px-4 py-8"><div class="text-center text-gray-600"><p>&copy; 2025 Jakob Külzer. All rights reserved.</p><div class="mt-4 space-x-6"><a href=mailto:jakob.kuelzer@gmail.com class="hover:text-teal-600 transition-colors">Email</a>
<a href=https://github.com/ilikeorangutans target=_blank class="hover:text-teal-600 transition-colors">Github</a>
<a href=https://sr.ht/~ilikeorangutans/ target=_blank class="hover:text-teal-600 transition-colors">Sourcehut</a>
<a href=https://www.linkedin.com/in/jakobkuelzer/ target=_blank class="hover:text-teal-600 transition-colors">LinkedIn</a></div></div></div></footer></body></html>