<!doctype html><html><head><meta charset=utf-8><title>Google Guice and Scope Mixing &mdash;
Jakob Külzer
</title><meta name=author value="Jakob Külzer"><meta property="og:title" content="Google Guice and Scope Mixing"><meta property="og:description" content="I&rsquo;ve been working on a small Java application I wrote a few years ago for some bug fixes and in the process of making it better, I introduced Google Guice, my favourite dependency injection framework. On of the great features of Guice is that it supports different scopes for injection. Per default, Guice will return a new object for every request. But sometimes you want to objects to be created a bit less liberally, for example, you want a certain object to be created only once. Guice has a @Singleton scope for that. Want an object to be created once for a request? Guice and guice-servlet offers @RequestScoped and SessionScoped. But there&rsquo;s more, need JUnit per test scope? Guiceberry has exactly that: @TestScoped that will make sure every test gets exactly one object."><meta property="og:type" content="article"><meta property="og:url" content="https://ilikeorangutans.github.io/2012/12/11/google-guice-and-scope-mixing/"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/output.css><link rel=canonical href=https://ilikeorangutans.github.io/></head><body class="bg-gray-50 text-gray-900"><header class="bg-white shadow-sm border-b"><div class="max-w-4xl mx-auto px-4 py-6"><nav class="flex justify-between items-center"><a href=/ class=navbar-brand><h1 class="text-2xl font-bold text-teal-900 hover:text-orange-400 transition-colors">Jakob Külzer</h1></a><div class=space-x-6><a href=/ class="text-gray-600 hover:text-orange-400 transition-colors">Home</a>
<a href=/posts/ class="text-gray-600 hover:text-orange-400 transition-colors">Blog</a>
<a href=/projects/ class="text-gray-600 hover:text-orange-400 transition-colors">Projects</a>
<a href=/about/ class="text-gray-600 hover:text-orange-400 transition-colors">About</a></div></nav></div></header><main class="max-w-4xl mx-auto px-4 py-8"><article class="bg-white rounded-lg shadow-sm overflow-hidden"><div class=p-6><div class="text-sm text-gray-500"><time datetime=2012-12-11>11 Dec 2012
</time><time datetime=2018-03-28>• updated 28 Mar 2018</time></div><h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">Google Guice and Scope Mixing</h1><div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-200"><div class="flex flex-wrap gap-2 mb-4"><a href=/tags/guice class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Guice
</a><a href=/tags/dependency-injection class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Dependency Injection
</a><a href=/tags/java class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">Java</a></div></div><div class="prose prose-lg max-w-none"><p>I&rsquo;ve been working on a small Java application I wrote a few years ago for some bug fixes and in the process of making it better, I introduced <a href=https://code.google.com/p/google-guice/>Google Guice</a>, my favourite dependency injection framework. On of the great features of Guice is that it supports different <a href=https://code.google.com/p/google-guice/wiki/Scopes>scopes for injection</a>. Per default, Guice will return a new object for every request. But sometimes you want to objects to be created a bit less liberally, for example, you want a certain object to be created only once. Guice has a <code>@Singleton</code> scope for that. Want an object to be created once for a request? Guice and <a href=https://code.google.com/p/google-guice/wiki/Servlets>guice-servlet</a> offers <code>@RequestScoped</code> and <code>SessionScoped</code>. But there&rsquo;s more, need JUnit per test scope? <a href=https://code.google.com/p/guiceberry/>Guiceberry</a> has exactly that: <code>@TestScoped</code> that will make sure every test gets exactly one object.</p><p>However, with scopes comes the challenge of nesting them. Not every object created in one scope may freely be used in another scope. For example, a request scoped object can not be injected into a singleton scoped object; after all, what should Guice inject? At the time the singleton is created, there are probably no requests. And what if there are multiple concurrent requests? Obviously, the singleton and the request scope are incompatible. In Guice parlance, the request scope is <em>narrower</em> than the singleton scope. Any attempt to inject a dependency from a narrower scope into a broader scope will cause Guice to throw an exception.</p><p>This opens a sleigh of different problems. For example, Servlets are kind of singletons, yet they need access to request scoped objects. And a session scoped object might need access to an a business service in the singleton scope. Luckily, Guice has an solution for that. Instead of injecting the dependency directly, Guice allows you to inject a <a href=http://google-guice.googlecode.com/git/javadoc/com/google/inject/Provider.html>Provider</a>, that is an object that <em>provides</em> other objects. Now, the provider is smart enough to decide when to create a new object or reuse the same one, effectively decoupling the injection target and source and their scopes. Creating a provider is straightforward. For example, to provide instances of <code>MyObject</code> in request scope, you&rsquo;d create the following class:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span><span style=color:#cbcbcb> </span>com.google.inject.Provider;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>import</span><span style=color:#cbcbcb> </span>com.google.inject.servlet.RequestScoped;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#ff8000;font-weight:700>@RequestScoped</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>public</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyProvider</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>implements</span><span style=color:#cbcbcb> </span>Provider<span style=color:#2c5dcd>&lt;</span>MyObject<span style=color:#2c5dcd>&gt;</span><span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span><span style=color:#2c5dcd;font-weight:700>public</span><span style=color:#cbcbcb> </span>MyObject<span style=color:#cbcbcb> </span><span style=color:#ff8000;font-weight:700>get</span>()<span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>		</span><span style=color:#0080ff;font-style:italic>// Create an instance of MyObject...</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>		</span><span style=color:#2c5dcd;font-weight:700>return</span><span style=color:#cbcbcb> </span>myObject;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span>}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>}</span></span></code></pre></div><p>To use request scoped instances of <code>MyObject</code> in a singleton scoped service, you&rsquo;d implement something like this class:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span><span style=color:#cbcbcb> </span>com.google.inject.Provider;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>import</span><span style=color:#cbcbcb> </span>javax.inject.Inject;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>import</span><span style=color:#cbcbcb> </span>javax.inject.Singleton;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#ff8000;font-weight:700>@Singleton</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>public</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>MyService</span><span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span><span style=color:#ff8000;font-weight:700>@Inject</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span><span style=color:#2c5dcd;font-weight:700>private</span><span style=color:#cbcbcb> </span>Provider<span style=color:#2c5dcd>&lt;</span>MyObject<span style=color:#2c5dcd>&gt;</span><span style=color:#cbcbcb> </span>myObjectProvider;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span><span style=color:#2c5dcd;font-weight:700>public</span><span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>void</span><span style=color:#cbcbcb> </span><span style=color:#ff8000;font-weight:700>doServiceThings</span>()<span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>		</span>MyObject<span style=color:#cbcbcb> </span>myObject<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>=</span><span style=color:#cbcbcb> </span>myObjectProvider.<span style=color:#2c5dcd;font-style:italic>get</span>();<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>		</span><span style=color:#0080ff;font-style:italic>// do things...</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>	</span>}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>}</span></span></code></pre></div><p>Notice how we inject <code>Provider&lt;MyObject></code> instead of <code>MyProvider</code> (this is a mistake I made initially). And in order to get an instance of <code>MyObject</code>, we call <code>provider.get()</code>. The service will always get the appropriate object for the current request (or whatever scope in question). A consequence of this is that the service has to be threadsafe in order to deal with concurrent requests. This applies for all objects that have to deal with objects from a narrower scope.</p><p>Once understood, Guice&rsquo;s scopes, and I&rsquo;m sure other dependency injection frameworks have similar concepts, are a powerful tool that greatly simplify development. Hopefully I was able to show some of their advantages and their use.</p></div></div></article><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ilikeorangutans.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer class="bg-white border-t mt-12"><div class="max-w-4xl mx-auto px-4 py-8"><div class="text-center text-gray-600"><p>&copy; 2025 Jakob Külzer. All rights reserved.</p><div class="mt-4 space-x-6"><a href=mailto:jakob.kuelzer@gmail.com class="hover:text-teal-600 transition-colors">Email</a>
<a href=https://github.com/ilikeorangutans target=_blank class="hover:text-teal-600 transition-colors">Github</a>
<a href=https://sr.ht/~ilikeorangutans/ target=_blank class="hover:text-teal-600 transition-colors">Sourcehut</a>
<a href=https://www.linkedin.com/in/jakobkuelzer/ target=_blank class="hover:text-teal-600 transition-colors">LinkedIn</a></div></div></div></footer></body></html>