<!doctype html><html><head><meta charset=utf-8><title>Zig, Memory, and the mysterious `170` &mdash;
Jakob Külzer
</title><meta name=author value="Jakob Külzer"><meta property="og:title" content="Zig, Memory, and the mysterious `170`"><meta property="og:description" content="I&rsquo;m hacking on a small Zig application with a GTK frontend, and part of using GTK is passing around ?*anyopaque pointers and you never quite know if it&rsquo;s working. In my app I&rsquo;m passing around a struct that holds a string []const u8 to various GTK callbacks. However the string was empty. This led me down a rabbit hole of trying to figure out if my pointers were correctly passed, even going as far as stepping through it with a debugger. Turns out, the pointers are all correct. Even my string []const u8 was there with the correct length, except every single byte was set to 170 and I realized I was looking at undefined memory. Zig in debug mode sets undefined memory to 0xaa which is 170."><meta property="og:type" content="article"><meta property="og:url" content="https://ilikeorangutans.github.io/2025/09/06/zig-memory-and-the-mysterious-170/"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/output.css><link rel=canonical href=https://ilikeorangutans.github.io/></head><body class="bg-gray-50 text-gray-900"><header class="bg-white shadow-sm border-b"><div class="max-w-4xl mx-auto px-4 py-6"><nav class="flex justify-between items-center"><a href=/ class=navbar-brand><h1 class="text-2xl font-bold text-teal-900 hover:text-orange-400 transition-colors">Jakob Külzer</h1></a><div class=space-x-6><a href=/ class="text-gray-600 hover:text-orange-400 transition-colors">Home</a>
<a href=/posts/ class="text-gray-600 hover:text-orange-400 transition-colors">Blog</a>
<a href=/projects/ class="text-gray-600 hover:text-orange-400 transition-colors">Projects</a>
<a href=/about/ class="text-gray-600 hover:text-orange-400 transition-colors">About</a></div></nav></div></header><main class="max-w-4xl mx-auto px-4 py-8"><article class="bg-white rounded-lg shadow-sm overflow-hidden"><div class=p-6><div class="text-sm text-gray-500"><time datetime=2025-09-06>6 Sep 2025
</time><time datetime=2025-09-06>• updated 6 Sep 2025</time></div><h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">Zig, Memory, and the mysterious <code>170</code></h1><div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-200"><div class="flex flex-wrap gap-2 mb-4"><a href=/tags/zig class="bg-gray-100 hover:bg-teal-100 text-gray-700 hover:text-teal-800 px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 cursor-pointer">zig</a></div></div><div class="prose prose-lg max-w-none"><p>I&rsquo;m hacking on a small Zig application with a GTK frontend, and part of using GTK is passing around <code>?*anyopaque</code> pointers and you never quite know if it&rsquo;s working. In my app I&rsquo;m passing around a struct that holds a <del>string</del> <code>[]const u8</code> to various GTK callbacks. However the string was empty. This led me down a rabbit hole of trying to figure out if my pointers were correctly passed, even going as far as stepping through it with a debugger. Turns out, the pointers are all correct. Even my <del>string</del> <code>[]const u8</code> was there with the correct length, except every single byte was set to <code>170</code> and I realized I was looking at undefined memory. Zig in debug mode sets undefined memory to <code>0xaa</code> which is <code>170</code>.</p><p>But why was my pointer pointing to undefined memory, I clearly initialized it?!</p><p>Turns out it <em>was</em> initialized and then it got uninitialized:</p><div class=highlight><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zig data-lang=zig><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>pub</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>fn</span><span style=color:#cbcbcb> </span><span style=color:#ff8000;font-weight:700>start</span>(allocator<span style=color:#2c5dcd>:</span><span style=color:#cbcbcb> </span>std.mem.Allocator)<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>!</span>MyStruct<span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>var</span><span style=color:#cbcbcb> </span>app<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>=</span><span style=color:#cbcbcb> </span>MyStruct{...};<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>var</span><span style=color:#cbcbcb> </span>envMap<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>=</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>try</span><span style=color:#cbcbcb> </span>std.process.<span style=color:#ff8000;font-weight:700>getEnvMap</span>(allocator);<span style=color:#cbcbcb>       </span><span style=color:#2c5dcd>&lt;-</span><span style=color:#cbcbcb> </span>get<span style=color:#cbcbcb> </span>the<span style=color:#cbcbcb> </span>map<span style=color:#cbcbcb> </span>of<span style=color:#cbcbcb> </span>env<span style=color:#cbcbcb> </span>vars<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>defer</span><span style=color:#cbcbcb> </span>envMap.<span style=color:#ff8000;font-weight:700>deinit</span>();<span style=color:#cbcbcb>                                   </span><span style=color:#2c5dcd>&lt;-</span><span style=color:#cbcbcb> </span>deinit<span style=color:#cbcbcb> </span>at<span style=color:#cbcbcb> </span>end<span style=color:#cbcbcb> </span>of<span style=color:#cbcbcb> </span>scope<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>if</span><span style=color:#cbcbcb> </span>(envMap.<span style=color:#ff8000;font-weight:700>get</span>(<span style=color:#0c6>&#34;NIRI_SOCKET&#34;</span>))<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>|</span>socket_path<span style=color:#2c5dcd>|</span><span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span>app.socket_path<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>=</span><span style=color:#cbcbcb> </span>socket_path;<span style=color:#cbcbcb>                         </span><span style=color:#2c5dcd>&lt;-</span><span style=color:#cbcbcb> </span>assign<span style=color:#cbcbcb> </span>socket_path<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>}<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>else</span><span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#0080ff;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span><span style=color:#cbcbcb>  </span>}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>return</span><span style=color:#cbcbcb> </span>app;<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#0080ff;font-style:italic>// later 
</span></span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic></span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>std.debug.<span style=color:#ff8000;font-weight:700>print</span>(<span style=color:#0c6>&#34;socket_path: {s}</span><span style=color:#c5060b;font-weight:700>\n</span><span style=color:#0c6>&#34;</span>,<span style=color:#cbcbcb> </span>.{app.socket_path});<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>&lt;-</span><span style=color:#cbcbcb> </span>nothing<span style=color:#2c5dcd>!</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>std.debug.<span style=color:#ff8000;font-weight:700>print</span>(<span style=color:#0c6>&#34;socket_path: {d}</span><span style=color:#c5060b;font-weight:700>\n</span><span style=color:#0c6>&#34;</span>,<span style=color:#cbcbcb> </span>.{app.socket_path});<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>&lt;-</span><span style=color:#cbcbcb> </span>{<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>170</span>,<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>170</span>,<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>170</span>,<span style=color:#cbcbcb> </span>...<span style=color:#cbcbcb> </span>}<span style=color:#cbcbcb>
</span></span></span></code></pre></div><p>It seems rather obvious now that I&rsquo;ve listed out the steps here, but it wasn&rsquo;t as I was debugging this. What&rsquo;s going wrong is that <code>getEnvMap</code> allocates memory for the socket path and then at the end of the scope, when <code>envMap.deinit()</code> is called, it clears it.</p><p>Coming from languages that &ldquo;magically&rdquo; handle strings for you it&rsquo;s a trap that I keep falling into. But having to think about when and where things actually reside in memory is a great exercise and makes me more conscious of the performance trade-offs involved.</p></div></div></article><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//ilikeorangutans.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer class="bg-white border-t mt-12"><div class="max-w-4xl mx-auto px-4 py-8"><div class="text-center text-gray-600"><p>&copy; 2025 Jakob Külzer. All rights reserved.</p><div class="mt-4 space-x-6"><a href=mailto:jakob.kuelzer@gmail.com class="hover:text-teal-600 transition-colors">Email</a>
<a href=https://github.com/ilikeorangutans target=_blank class="hover:text-teal-600 transition-colors">Github</a>
<a href=https://sr.ht/~ilikeorangutans/ target=_blank class="hover:text-teal-600 transition-colors">Sourcehut</a>
<a href=https://www.linkedin.com/in/jakobkuelzer/ target=_blank class="hover:text-teal-600 transition-colors">LinkedIn</a></div></div></div></footer></body></html>